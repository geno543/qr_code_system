<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner - Event System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-qrcode"></i> QR Event System</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home"></i> Home</a>
                <a class="nav-link" href="/admin"><i class="fas fa-cog"></i> Admin</a>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h2><i class="fas fa-scan text-primary"></i> QR Code Scanner</h2>
                    <p class="text-muted">Simple and reliable QR code scanning</p>
                </div>

                <!-- Manual Entry Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-keyboard"></i> Manual QR Entry</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="qrInput" class="form-label">QR Code Data:</label>
                            <textarea id="qrInput" class="form-control" rows="3" 
                                placeholder='Paste QR code data here (format: {"token":"abc123..."})'></textarea>
                        </div>
                        <button id="validateQR" class="btn btn-primary">
                            <i class="fas fa-check"></i> Validate QR Code
                        </button>
                        <button id="clearInput" class="btn btn-secondary ms-2">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Search Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-search"></i> Search Attendee</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nameSearch" class="form-label">Name:</label>
                                    <input type="text" id="nameSearch" class="form-control" placeholder="Enter attendee name">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="ticketSearch" class="form-label">Ticket ID:</label>
                                    <input type="text" id="ticketSearch" class="form-control" placeholder="Enter ticket ID">
                                </div>
                            </div>
                        </div>
                        <button id="searchAttendee" class="btn btn-success">
                            <i class="fas fa-search"></i> Search & Check In
                        </button>
                        <button id="clearSearch" class="btn btn-secondary ms-2">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Test QR Codes Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-qrcode"></i> Test QR Codes</h5>
                    </div>
                    <div class="card-body">
                        <div id="testQRCodes">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading test QR codes...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Result Display -->
                <div id="result" style="display: none;"></div>

                <!-- Statistics -->
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card text-center bg-success text-white">
                            <div class="card-body">
                                <h4 id="successCount">0</h4>
                                <p class="mb-0">Successful</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-danger text-white">
                            <div class="card-body">
                                <h4 id="errorCount">0</h4>
                                <p class="mb-0">Failed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-info text-white">
                            <div class="card-body">
                                <h4 id="duplicateCount">0</h4>
                                <p class="mb-0">Duplicates</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center bg-primary text-white">
                            <div class="card-body">
                                <h4 id="totalCount">0</h4>
                                <p class="mb-0">Total</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Scanner page loaded');
        
        // Global variables
        let stats = {
            success: 0,
            error: 0,
            duplicate: 0,
            total: 0
        };

        // Manual Entry Functions
        document.getElementById('validateQR').addEventListener('click', function() {
            console.log('Validate QR clicked');
            const qrData = document.getElementById('qrInput').value.trim();
            if (!qrData) {
                showResult('Please enter QR code data', 'warning');
                return;
            }
            processQRCode(qrData);
        });

        document.getElementById('clearInput').addEventListener('click', function() {
            document.getElementById('qrInput').value = '';
        });

        // Search Functions
        document.getElementById('searchAttendee').addEventListener('click', function() {
            console.log('Search attendee clicked');
            const name = document.getElementById('nameSearch').value.trim();
            const ticketId = document.getElementById('ticketSearch').value.trim();
            
            if (!name && !ticketId) {
                showResult('Please enter name or ticket ID', 'warning');
                return;
            }

            searchAttendee(name, ticketId);
        });

        document.getElementById('clearSearch').addEventListener('click', function() {
            document.getElementById('nameSearch').value = '';
            document.getElementById('ticketSearch').value = '';
        });

        // Search attendee function
        async function searchAttendee(name, ticketId) {
            try {
                const response = await fetch('/search-attendee', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, ticketId: ticketId })
                });

                const result = await response.json();
                handleScanResult(result);
                
            } catch (error) {
                console.error('Search error:', error);
                stats.error++;
                updateStats();
                showResult('❌ Network error: ' + error.message, 'danger');
            }
        }

        // QR Code Processing
        async function processQRCode(qrData) {
            try {
                const response = await fetch('/validate-qr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ qrData: qrData })
                });

                const result = await response.json();
                handleScanResult(result);
                
            } catch (error) {
                console.error('QR validation error:', error);
                stats.error++;
                updateStats();
                showResult('❌ Network error: ' + error.message, 'danger');
            }
        }

        function handleScanResult(result) {
            stats.total++;
            
            if (result.success) {
                stats.success++;
                showResult('✅ Welcome ' + result.attendee.name + '! (' + result.attendee.ticketId + ')', 'success');
            } else {
                if (result.message.includes('already')) {
                    stats.duplicate++;
                } else {
                    stats.error++;
                }
                showResult('❌ ' + result.message, 'danger');
            }
            
            updateStats();
        }

        // Utility Functions
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'danger' ? 'alert-danger' : 
                             type === 'warning' ? 'alert-warning' : 'alert-info';
            
            resultDiv.innerHTML = '<div class="alert ' + alertClass + '">' + message + '</div>';
            resultDiv.style.display = 'block';

            setTimeout(function() {
                resultDiv.style.display = 'none';
            }, 5000);
        }

        function updateStats() {
            document.getElementById('successCount').textContent = stats.success;
            document.getElementById('errorCount').textContent = stats.error;
            document.getElementById('duplicateCount').textContent = stats.duplicate;
            document.getElementById('totalCount').textContent = stats.total;
        }

        function copyQRData(qrData) {
            document.getElementById('qrInput').value = qrData;
            showResult('QR data copied to manual entry. Click "Validate QR Code" to test.', 'info');
        }

        // Load Test QR Codes
        function loadTestQRCodes() {
            console.log('Loading test QR codes...');
            
            fetch('/admin/attendees')
                .then(function(response) {
                    console.log('API response:', response.status);
                    if (!response.ok) {
                        throw new Error('Failed to load attendees');
                    }
                    return response.json();
                })
                .then(function(attendees) {
                    console.log('Attendees loaded:', attendees.length);
                    const container = document.getElementById('testQRCodes');
                    
                    if (attendees.length === 0) {
                        container.innerHTML = '<p class="text-muted text-center">No attendees found. <a href="/">Upload Excel file first</a></p>';
                        return;
                    }

                    let html = '<div class="row">';
                    for (let i = 0; i < Math.min(attendees.length, 6); i++) {
                        const attendee = attendees[i];
                        const qrData = JSON.stringify({ token: attendee.qr_token });
                        const safeQrData = qrData.replace(/'/g, "\\'");
                        
                        html += '<div class="col-md-4 mb-3">';
                        html += '<div class="card">';
                        html += '<div class="card-body text-center">';
                        html += '<h6>' + attendee.name + '</h6>';
                        html += '<p class="small text-muted">' + attendee.ticket_id + '</p>';
                        html += '<img src="/qr/' + attendee.qr_code_path + '" style="width: 120px; height: 120px;" alt="QR Code" class="mb-2">';
                        html += '<br>';
                        html += '<button class="btn btn-sm btn-outline-primary" onclick="copyQRData(\'' + safeQrData + '\')">';
                        html += '<i class="fas fa-copy"></i> Copy Data';
                        html += '</button>';
                        html += '</div></div></div>';
                    }
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(function(err) {
                    console.error('Error loading test data:', err);
                    document.getElementById('testQRCodes').innerHTML = '<p class="text-danger text-center">Error loading test data. Make sure you have test attendees.</p>';
                });
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            console.log('Window loaded, initializing...');
            loadTestQRCodes();
        });
    </script>
</body>
</html>
